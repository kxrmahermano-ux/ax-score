name: Auto Label

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  auto-label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get changed files
        id: files
        uses: tj-actions/changed-files@v44
        with:
          json: true

      - name: Determine labels
        id: labels
        env:
          CHANGED_FILES: ${{ steps.files.outputs.all_changed_files }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          LABELS=()

          # Parse changed files and assign area labels
          for file in $CHANGED_FILES; do
            if [[ $file =~ ^src/gatherers/ ]]; then
              LABELS+=("area: gatherers")
            elif [[ $file =~ ^src/audits/ ]]; then
              LABELS+=("area: audits")
            elif [[ $file =~ ^src/reporter/ ]]; then
              LABELS+=("area: reporter")
            elif [[ $file =~ ^src/bin/ ]]; then
              LABELS+=("area: cli")
            elif [[ $file =~ ^src/config/ ]]; then
              LABELS+=("area: config")
            elif [[ $file =~ ^docs/ ]]; then
              LABELS+=("type: documentation")
            elif [[ $file =~ ^\.github/ ]]; then
              LABELS+=("area: infrastructure")
            elif [[ $file =~ (test|__tests__|\.test\.|\.spec\.) ]]; then
              LABELS+=("area: testing")
            fi

            if [[ $file =~ package\.json$ ]] || [[ $file =~ pnpm-lock\.yaml$ ]]; then
              LABELS+=("dependencies")
            fi
          done

          # Check for breaking changes
          if [[ "$PR_TITLE" =~ BREAKING ]] || [[ "$PR_BODY" =~ BREAKING ]]; then
            LABELS+=("breaking-change")
          fi

          # Remove duplicates and format as JSON array
          UNIQUE_LABELS=($(printf '%s\n' "${LABELS[@]}" | sort -u))
          LABELS_JSON=$(printf '%s\n' "${UNIQUE_LABELS[@]}" | jq -R . | jq -s .)

          echo "labels=$LABELS_JSON" >> "$GITHUB_OUTPUT"

      - name: Apply labels
        if: fromJson(steps.labels.outputs.labels)[0] != null
        uses: actions/github-script@v7
        with:
          script: |
            const labels = ${{ steps.labels.outputs.labels }};
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: labels
            });
